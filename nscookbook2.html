<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>NEMOSIM - Cook book (2) &mdash; nemosim 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="nemosim 1.0 documentation" href="index.html" />
    <link rel="next" title="NEMOSIM - Cook book (3)" href="nscookbook3.html" />
    <link rel="prev" title="NEMOSIM - Cook book (1)" href="nscookbook.html" /> 
  </head>
  <body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="index.html"><img src="_images/NEMO-Website.png" border="0" alt="nemosim"/></a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="nscookbook3.html" title="NEMOSIM - Cook book (3)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="nscookbook.html" title="NEMOSIM - Cook book (1)"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">home</a>|&nbsp;</li>
        <li><a href="search.html">search</a>|&nbsp;</li>
       <li><a href="contents.html">documentation </a> &raquo;</li>
 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">NEMOSIM - Cook book (2)</a><ul>
<li><a class="reference internal" href="#increasing-productivity">Increasing productivity</a></li>
<li><a class="reference internal" href="#using-multiple-threads">1. Using multiple threads</a></li>
<li><a class="reference internal" href="#reusing-the-mapping-matrix">2. Reusing the mapping matrix</a></li>
<li><a class="reference internal" href="#command-inheritance">3. Command inheritance</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="nscookbook.html"
                        title="previous chapter">NEMOSIM - Cook book (1)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="nscookbook3.html"
                        title="next chapter">NEMOSIM - Cook book (3)</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/nscookbook2.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="nemosim-cook-book-2">
<span id="nscookbook2"></span><h1>NEMOSIM - Cook book (2)<a class="headerlink" href="#nemosim-cook-book-2" title="Permalink to this headline">¶</a></h1>
<div class="section" id="increasing-productivity">
<h2>Increasing productivity<a class="headerlink" href="#increasing-productivity" title="Permalink to this headline">¶</a></h2>
<p>It will already be evident that producing high quality images is going to require: a
moderate amount of computing power (dependent on target resolution); a long argument list
(dependent on design complexity) or, most probably, both. Fortunately, NEMOSIM has options
to help produce results more quickly and to reduce the user input required. Firstly, the
computational task can be shared across multiple threads (where available). Secondly, the
pixel-space to model index mapping matrix can be saved and reused for subsequent images
that use the same view parameters.  Thirdly, NEMOSIM uses a command inheritance system
which allows settings to be inherited from existing results. This section of the cookbook
explains these options in more detail.</p>
</div>
<div class="section" id="using-multiple-threads">
<h2>1. Using multiple threads<a class="headerlink" href="#using-multiple-threads" title="Permalink to this headline">¶</a></h2>
<p>When available, NEMOSIM will have been compiled with OpenMP support. Multiple computing
threads are used to speed up the computation of the pixel-space to model index mapping
which is the most computationally demanding part of the overall task (especially for high
resolution images from high resolution model output). The user can assert control using
the <tt class="docutils literal"><span class="pre">-np</span></tt> option to declare the number of OpenMP threads to use. Otherwise, the default
is to use half the physical number available (or one in a single-core environment). This
choice should suffice in most circumstances but different values may be beneficial in
either sole-use environments or in heavily used shared environments. The number of threads
available and the number used will be reported by NEMOSIM for any verbosity level greater
than zero (set via the <tt class="docutils literal"><span class="pre">-rpt</span></tt> option). The following example illustrates the performance
benefit of using increasing numbers of threads. Note in this relatively small example there
are diminishing (but still beneficial) gains for more than a few threads:</p>
<div class="highlight-python"><div class="highlight"><pre>./nemosim -f ./data/ORCA025_2001m01I.nc -o examples/example4a.png  -d isstempe -nomask -spos 3 -icosa \
          -show -no_offset -rpt 1 -np 1
        OMP threads/ max. threads/ num procs     :    1/ 1/12
                         image creation time     =    6.773

./nemosim -f ./data/ORCA025_2001m01I.nc -o examples/example4a.png  -d isstempe -nomask -spos 3 -icosa \
          -show -no_offset -rpt 1 -np 2
        OMP threads/ max. threads/ num procs     :    2/ 2/12
                         image creation time     =    4.923

./nemosim -f ./data/ORCA025_2001m01I.nc -o examples/example4a.png  -d isstempe -nomask -spos 3 -icosa \
          -show -no_offset -rpt 1 -np 3
        OMP threads/ max. threads/ num procs     :    3/ 3/12
                         image creation time     =    4.350

./nemosim -f ./data/ORCA025_2001m01I.nc -o examples/example4a.png  -d isstempe -nomask -spos 3 -icosa \
          -show -no_offset -rpt 1 -np 4
        OMP threads/ max. threads/ num procs     :    4/ 4/12
                         image creation time     =    4.298

./nemosim -f ./data/ORCA025_2001m01I.nc -o examples/example4a.png  -d isstempe -nomask -spos 3 -icosa \
          -show -no_offset -rpt 1
        OMP threads/ max. threads/ num procs     :    6/ 6/12   (default # threads)
                         image creation time     =    3.914

./nemosim -f ./data/ORCA025_2001m01I.nc -o examples/example4a.png  -d isstempe -nomask -spos 3 -icosa \
          -show -no_offset -rpt 1 -np 8
        OMP threads/ max. threads/ num procs     :    8/ 8/12
                         image creation time     =    4.074

./nemosim -f ./data/ORCA025_2001m01I.nc -o examples/example4a.png  -d isstempe -nomask -spos 3 -icosa \
          -show -no_offset -rpt 1 -np 12
        OMP threads/ max. threads/ num procs     :   12/12/12
                         image creation time     =    3.881
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/example4a.png"><img alt="_images/example4a.png" class="align-center" src="_images/example4a.png" style="width: 477.0px; height: 250.0px;" /></a>
</div>
<div class="section" id="reusing-the-mapping-matrix">
<h2>2. Reusing the mapping matrix<a class="headerlink" href="#reusing-the-mapping-matrix" title="Permalink to this headline">¶</a></h2>
<p>NEMOSIM works by calculating a mapping from pixel-space to model grid-cell indices and
then using the value of the model field in each identified grid-cell to determine the
pixel colour. This approach allows for very high resolution images to be produced that
faithfully represent the resolution of the source model. The method allows very large
images to be produced (e.g. for display banners) without relying on software scaling of
smaller images and suffering the inevitable blurring of crisp edges. However, calculating
the mapping matrix can be computationally expensive; especially for high resolution
image/high resolution model combinations. Continuing algorithmic improvements and
multi-thread utilisation can help reduce the image creation time, but the overhead is
still too large for some practical applications.</p>
<p>Fortunately, the mapping matrix is a function of only the target image size, source model
grid geometry and user view parameters. It is independent of the actual model field and
all other user choices (such as scale type, scale limits, annotations, foreground and
background colours, fonts and margin settings). This means, for example, that in the
production of video frames for a timeseries of model results where only the model field
data is changing, the mapping matrix can be calculated and stored when producing the first
frame for re-use by all subsequent frames.</p>
<p>It is in such uses that the scriptable nature of NEMOSIM truly comes into its own. The
creation time for images can be reduced from minutes (sometimes, tens of minutes) to a few
seconds or less when re-using the mapping matrix. For very long animated sequences the
production of frames can even be carried out using simple task-farming techniques on a
suitably configured cluster.</p>
<p>The creation and subsequent re-use of a mapping matrix is triggered via the <tt class="docutils literal"><span class="pre">-usemap</span></tt> option.
This option takes a single argument which is the name of a NetCDF file which will be either:</p>
<blockquote>
<div><ul class="simple">
<li>created and filled with the mapping data and associated information (if it doesn&#8217;t exist)</li>
<li>opened and read to obtain the mapping data (if it already exists)</li>
</ul>
</div></blockquote>
<p>The use of NetCDF means that these files are portable between systems and, crucially, can
contain sufficient metadata for basic sanity checks. Before explaining this further it is
useful to look at an example. Firstly, recreate the previous image but add the usemap option
to save the mapping data:</p>
<div class="highlight-python"><div class="highlight"><pre>./nemosim -f ./data/ORCA025_2001m01I.nc -o examples/example4a.png -d isstempe -nomask -spos 3 -icosa \
          -show -no_offset -rpt 1 -np 1 -usemap icosa.nc
       OMP threads/ max. threads/ num procs     :    1/ 1/12
                        image creation time     =     6.757
</pre></div>
</div>
<p>Now with the mapping data we can recreate the image quickly and even change non-map
related properties in the process. Here, for example, the colour palette is changed:</p>
<div class="highlight-python"><div class="highlight"><pre>./nemosim -f ./data/ORCA025_2001m01I.nc -o examples/example4b.png -d isstempe -nomask -spos 3 -icosa \
          -show -no_offset -rpt 1 -np 1 -usemap icosa.nc -cs brown2green.pal
       OMP threads/ max. threads/ num procs     :    1/ 1/12
                        image creation time     =     0.026
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/example4b.png"><img alt="_images/example4b.png" class="align-center" src="_images/example4b.png" style="width: 477.0px; height: 250.0px;" /></a>
<p>Note how much more quickly the image was created this time even though we continue to
employ just a single thread. We could continue to use this mapping data for any compatible
data source and target image. Provided the grids match, different data fields could be
read from different data files and all ancillary settings can be altered. Here we continue
to plot the SST field but change the colour palette again and change scale and title
settings:</p>
<div class="highlight-python"><div class="highlight"><pre>./nemosim -f ./data/ORCA025_2001m01I.nc -o examples/example4c.png -d isstempe -nomask -spos 4 -icosa \
          -show -no_offset -rpt 1 -np 1 -usemap icosa.nc -cs best64.pal -limits -2. 28. \
          -title &#39;Sea Surface Temperature (C)&#39; -stitle SST
       OMP threads/ max. threads/ num procs     :    1/ 1/12
                        image creation time     =     0.026
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/example4c.png"><img alt="_images/example4c.png" class="align-center" src="_images/example4c.png" style="width: 477.0px; height: 250.0px;" /></a>
<p>It is worth noting the contents of the map file which is easy to reveal using the standard
<tt class="docutils literal"><span class="pre">ncdump</span></tt> netCDF utility:</p>
<div class="highlight-python"><div class="highlight"><pre>ncdump -h icosa.nc
netcdf icosa {
dimensions:
        x = 720 ;
        y = 400 ;
variables:
        int pix2ij(y, x) ;

//   global attributes:
              :Source_size = 1442, 1021 ;
              :Image_size = 720, 400 ;
              :Command = &quot;./nemosim -f ./data/ORCA025_2001m01I.nc -o examples/example4c.png -d isstempe
                          -nomask -spos 3 -icosa -show -no_offset -rpt 1 -np 1 -usemap icosa.nc&quot; ;
              :Work_dir = &quot;/Users/acc/NEMO/NEMOSIM/NemoSim&quot; ;
              :Utility = &quot;nemosim created by acc@noc.ac.uk (National Oceanography Centre, UK)&quot; ;
}
</pre></div>
</div>
<p>The main content is an integer array (pix2ij), the same size and shape as the target
image, which contains a combined i,j model index for each image pixel. Additional global
attributes are stored which allow some simple sanity checks to be performed when the map is
reused. For example, it is a detectable error to attempt to use the same map to generate a
different size image:</p>
<div class="highlight-python"><div class="highlight"><pre>./nemosim -f ./data/ORCA025_2001m01I.nc -o tmpme.png -d isstempe -nomask -spos 3 -icosa -show \
                                        -no_offset -np 1 -usemap icosa.nc -r 800 400
 Sanity check failed in icosa.nc
 Requested destination image size of:               800         400
 Pixel to ij map is for a image size of:            720         400
STOP map mismatch
</pre></div>
</div>
<p>Likewise it is a detectable error to employ the same map with different size input fields:</p>
<div class="highlight-python"><div class="highlight"><pre>./nemosim -f ./data/ORCA1_2006m09T.nc -o tmpme.png -d votemper -nomask -spos 3 -icosa -show \
                                      -no_offset -np 1 -usemap icosa.nc
 Sanity check failed in icosa.nc
 Supplied source size of:                          362         292
 Pixel to ij map is for a source size of:         1442        1021
STOP map mismatch
</pre></div>
</div>
<p>These are necessary checks but not sufficient to guarantee the expected results. For
example, this attempt to produce an orthogonal projection image will ignore the
projection parameters and reproduce the icosahedral projection image:</p>
<div class="highlight-python"><div class="highlight"><pre>./nemosim -f ./data/ORCA025_2001m01I.nc -o tmpme.png -d isstempe -nomask -spos 3 -ortho -eu1 80. \
          -show -no_offset -rpt 1 -np 1 -usemap icosa.nc
</pre></div>
</div>
<p>Other attributes include the current working directory that may help establish provenance
should map files be moved later and a copy of the command which was invoked to produce the
map file. This attribute may not be an exact replica of the command because redundant
arguments will have been removed by <tt class="docutils literal"><span class="pre">nemosim</span></tt>. Redundant arguments occur if an option is
supplied more than once; only the last example of each option and its associated arguments
will be retained. This is because the command-line parsing is performed from left to right
and any recurring options will overwrite earlier settings. This behaviour is useful and
important for the command inheritance functionality described in the next section.</p>
</div>
<div class="section" id="command-inheritance">
<h2>3. Command inheritance<a class="headerlink" href="#command-inheritance" title="Permalink to this headline">¶</a></h2>
<p>The range of options that nemosim supports and the complexity of the commands for
well-crafted images is likely to discourage casual users from regular use. However, the
command inheritance capability goes a long way to removing these burdens by providing a
mechanism for constructing images based on previous work. In its simplest form the
inheritance function (triggered by the <tt class="docutils literal"><span class="pre">-as</span></tt> option) can be used to repeat a previous
command. Say, for example, that the example4c.png file had been accidently deleted. There
is no need to worry about reconstructing the command because a copy exists in the map file
and <tt class="docutils literal"><span class="pre">nemosim</span></tt> can be instructed to extract and execute this command with:</p>
<div class="highlight-python"><div class="highlight"><pre>./nemosim -as icosa.nc
</pre></div>
</div>
<p>What may be less obvious is that an accidental deletion of the map file is also
recoverable.  This is because, <tt class="docutils literal"><span class="pre">nemosim</span></tt> also uses the comment field available in JPEG
and PNG images to store the image creation command. Thus:</p>
<div class="highlight-python"><div class="highlight"><pre>./nemosim -as examples/example4c.png
</pre></div>
</div>
<p>will recreate the image either using the existing map file or from scratch (thereby
recreating the map file) if it no longer exists. Currently, <tt class="docutils literal"><span class="pre">nemosim</span></tt> invokes an
external script to access the comment field. This script (bin/rdimgcom) must be in the
users <tt class="docutils literal"><span class="pre">$PATH</span></tt> for this to work AND <tt class="docutils literal"><span class="pre">nemosim</span></tt> needs to have been compiled with a
FORTRAN 2008 standards compliant compiler. This is because the command is run via the
<tt class="docutils literal"><span class="pre">EXECUTE_COMMAND_LINE</span></tt> function that was introduced into the standard at that date.
Users will be warned when this is attempted with older compilers and given instructions
for a two-stage alternative which involves:</p>
<blockquote>
<div><ul class="simple">
<li>Running rdimgcom manually and redirecting output to a text file</li>
<li>Running <tt class="docutils literal"><span class="pre">nemosim</span></tt> with this text file as the argument to the <tt class="docutils literal"><span class="pre">-as</span></tt> option</li>
</ul>
</div></blockquote>
<p>For example:</p>
<div class="highlight-python"><div class="highlight"><pre>./nemosim -as tmpme.png
****************************************************
* Sorry EXECUTE_COMMAND_LINE is not available with *
* this fortran compiler. Cloning a previous image  *
* directly is not possible.                        *
* Run ./bin/rdimgcom ../tmpme.png manually,        *
* redirect the results into a text file, and       *
* rerun nemosim using this text file as the        *
* argument to the -as option instead. E.g.:        *
*     ./bin/rdimgcom tryme.png &gt; tryme.cmd         *
*     ./nemosim -as tryme.cmd -o tryme2.png        *
****************************************************
</pre></div>
</div>
<p>It should be noted that the rdimgcom script creates a temporary file during its operation.
This temporary file is subsequently deleted but it does mean that the script must be
invoked within a working directory for which the user has write permission.  When running
the script manually, the user may avoid this restriction by providing a 2nd argument
naming a directory where temporary files may be created. For example:</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir noperms ; chmod a-w noperms ; cd noperms
../bin/rdimgcom ../tmpme.png

Sorry. Unable to create temporary file:  ./1066_tmp.txt
Either the directory is not writable or the file already exists
You can try providing a directory for the temporary file as a 2nd argumnt

Usage: rdimgcom image_file [directory_for_temporary_file]

../bin/rdimgcom ../tmpme.png ..

./nemosim -f ./data/ORCA025_2001m01I.nc -o tmpme.png -d isstempe \
          -nomask -spos 3 -ortho -eu1 80. -show -no_offset -rpt 1 -np 1 \
          -usemap icosa.nc
</pre></div>
</div>
<p>Note it is very unlikely that the temporary file already exists since it&#8217;s name is formed
using the process id which should be unique. When invoked internally via the
<tt class="docutils literal"><span class="pre">EXECUTE_COMMAND_LINE</span></tt> function there is currently no option for providing an
alternative directory. Any difficulty in creating the temporary file will result in the
same compiler-related error message as shown above and the user will have to resort to the
two-stage method as instructed.</p>
<p>In summary, <tt class="docutils literal"><span class="pre">nemosim</span></tt> can accept three sources of command inheritance via the <tt class="docutils literal"><span class="pre">-as</span></tt>
option:</p>
<blockquote>
<div><ul class="simple">
<li>From the <tt class="docutils literal"><span class="pre">Command</span></tt> attribute stored within a netCDF map file</li>
<li>From the comment field stored within a <tt class="docutils literal"><span class="pre">nemosim</span></tt> generated JPG or PNG</li>
<li>From an ASCII text file containing just the command line text. This can be created
manually or from redirected output from the rdimgcom script. Long argument lists can
be provided across multiple, &#8216;\&#8217;-terminated, lines</li>
</ul>
</div></blockquote>
<p>Note that subsequent manipulation of an image with other tools may remove comments within
JPG and PNG files. If there is a risk of this then use <tt class="docutils literal"><span class="pre">rdimgcom</span></tt> to extract the command
and save in a text file before operating on <tt class="docutils literal"><span class="pre">nemosim</span></tt> generated images. A second script
is provided (<tt class="docutils literal"><span class="pre">wrimgcom</span></tt>) for reinserting comments from text files in these
circumstances:</p>
<div class="highlight-python"><div class="highlight"><pre>./bin/wrimgcom cmd.txt tmpme.png
</pre></div>
</div>
<p>So far we&#8217;ve used command inheritance to simply recreate images. Obviously it is useful to
maintain a record of the creation command, and this is especially true when that record is
carried within the image itself, but the facility is even more useful when combined with
the ability of <tt class="docutils literal"><span class="pre">nemosim</span></tt> to ignore all but the last occurrence of each option-argument
pairing. This means that creating images that are variations of existing ones can be
easily achieved with minimal arguments. For example:</p>
<div class="highlight-python"><div class="highlight"><pre>./nemosim -as icosa.nc -d Bathy_level -f ./data/bathy_level.nc -o examples/example4d.png
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/example4d.png"><img alt="_images/example4d.png" class="align-center" src="_images/example4d.png" style="width: 477.0px; height: 250.0px;" /></a>
<p>Note that the command subsequently stored in the output image will have had any redundancy
removed. Note also that the attribute in icosa.nc is unchanged:</p>
<div class="highlight-python"><div class="highlight"><pre>./bin/rdimgcom example4d.png

./nemosim -f ./data/bathy_level.nc -o examples/example4d.png -d \
Bathy_level -nomask -spos 3 -icosa -no_offset -np 1 -usemap icosa.nc
</pre></div>
</div>
<p>Variations of this last image can be continued most simply by inheritance from the image itself:</p>
<div class="highlight-python"><div class="highlight"><pre>./nemosim -as examples/example4d.png -cs bathy.pal -bbg gray -o examples/example4e.png
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/example4e.png"><img alt="_images/example4e.png" class="align-center" src="_images/example4e.png" style="width: 475.0px; height: 248.0px;" /></a>
<p>Finally, note that even the projection can be changed simply by naming a new map file
(which will be created if it doesn&#8217;t already exist):</p>
<div class="highlight-python"><div class="highlight"><pre>./nemosim -as examples/example4e.png -usemap ortho.nc -ortho -eu2 70. -eu1 120. -o examples/example4f.png
 usemap requested but ortho.nc does not exist. File will be created.
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/example4f.png"><img alt="_images/example4f.png" class="align-center" src="_images/example4f.png" style="width: 475.0px; height: 248.0px;" /></a>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="nscookbook3.html" title="NEMOSIM - Cook book (3)"
             >next</a> |</li>
        <li class="right" >
          <a href="nscookbook.html" title="NEMOSIM - Cook book (1)"
             >previous</a> |</li>
        <li><a href="index.html">home</a>|&nbsp;</li>
        <li><a href="search.html">search</a>|&nbsp;</li>
       <li><a href="contents.html">documentation </a> &raquo;</li>
 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, Andrew C. Coward, National Oceanography Centre, UK.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>